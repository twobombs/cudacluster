FROM twobombs/cudacluster:vulkan

# libs
RUN apt update && apt-get install libgl1-mesa-dev freeglut3-dev libglew-dev cmake build-essential && apt clean all
# NV, OCL & Mesa samples building
RUN git clone https://github.com/NVIDIA/cuda-samples.git && cd cuda-samples && make -k -i -j2

#
RUN git clone https://github.com/twobombs/cuda-workshop.git && cd cuda-workshop && cd shrutil && cmake . && make shrutil
COPY oclSamples.tar.gz /oclSamples.tar.gz
RUN tar -xf oclSamples.tar.gz

#
RUN git clone https://github.com/freedesktop/mesa-demos.git && cd mesa-demos && cmake . && make -k -i -j2 && make install 

# HPC SDK
RUN curl https://developer.download.nvidia.com/hpc-sdk/ubuntu/DEB-GPG-KEY-NVIDIA-HPC-SDK | gpg --dearmor -o /usr/share/keyrings/nvidia-hpcsdk-archive-keyring.gpg
RUN echo 'deb [signed-by=/usr/share/keyrings/nvidia-hpcsdk-archive-keyring.gpg] https://developer.download.nvidia.com/hpc-sdk/ubuntu/amd64 /' | tee /etc/apt/sources.list.d/nvhpc.list
RUN apt update -y && apt install nvhpc-22-9-cuda-multi

ENV NVIDIA_VISIBLE_DEVICES all
ENV NVIDIA_DRIVER_CAPABILITIES graphics,utility,compute

EXPOSE 6080

ENTRYPOINT /root/run
